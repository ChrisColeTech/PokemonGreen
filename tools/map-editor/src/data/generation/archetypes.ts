import { DEFAULT_MAP_HEIGHT, DEFAULT_MAP_WIDTH, GRASS_TILE_ID } from '../tiles'
import type {
  ArchetypeId,
  GenerationPassId,
  HardConstraintId,
  RandomMapArchetype,
  SoftGoalId,
} from '../../types/generation'

export const DEFAULT_GENERATION_PASSES: GenerationPassId[] = [
  'initialize',
  'carvePrimaryPaths',
  'paintBiomes',
  'reserveDistricts',
  'placeBuildings',
  'placeEncounters',
  'placeInteractivesAndEntities',
  'balance',
  'validate',
  'repair',
  'finalize',
]

export const GENERATION_HARD_CONSTRAINTS: HardConstraintId[] = [
  'boundedMap',
  'knownTileIdsOnly',
  'reachableCriticalPath',
  'buildingFootprintsInBounds',
  'buildingDoorConnectivity',
  'minRequiredStructures',
  'spawnSafety',
]

export const DEFAULT_HARD_CONSTRAINT_POLICY: Record<HardConstraintId, boolean> = {
  boundedMap: true,
  knownTileIdsOnly: true,
  reachableCriticalPath: true,
  buildingFootprintsInBounds: true,
  buildingDoorConnectivity: true,
  minRequiredStructures: true,
  spawnSafety: true,
}

export const DEFAULT_SOFT_GOAL_WEIGHTS: Record<SoftGoalId, number> = {
  routeReadability: 1,
  biomeVariety: 1,
  townCoherence: 1,
  encounterPacing: 1,
  landmarkVisibility: 1,
}

export const GENERATION_TILE_ROLE_DEFAULTS = {
  baseTerrainTileId: GRASS_TILE_ID,
  primaryPathTileId: 2,
  optionalWaterTileIds: [0, 17],
  optionalEncounterTileIds: [7, 28],
} as const

export const DEFAULT_GENERATION_MAX_REPAIR_ATTEMPTS = 3

export const RANDOM_MAP_ARCHETYPE_PRESETS: RandomMapArchetype[] = [
  {
    id: 'town_route_basic',
    label: 'Town + Route (Basic)',
    description: 'Single town core connected to one readable route.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH,
      height: DEFAULT_MAP_HEIGHT,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.2,
      biomeVariety: 0.9,
      townCoherence: 1.2,
      encounterPacing: 1,
      landmarkVisibility: 0.8,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 1, max: 1 },
      gym: { min: 0, max: 1 },
      'house-small': { min: 2, max: 5 },
      'house-large': { min: 0, max: 2 },
      gate: { min: 0, max: 2 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [0, 17],
      optionalEncounterTileIds: [7],
    },
  },
  {
    id: 'coastal_town_route',
    label: 'Coastal Town + Route',
    description: 'Town and route composition with shoreline influence and bridge options.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 5,
      height: DEFAULT_MAP_HEIGHT,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1,
      biomeVariety: 1.3,
      townCoherence: 1,
      encounterPacing: 0.9,
      landmarkVisibility: 1.1,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 1, max: 1 },
      'house-small': { min: 2, max: 4 },
      'house-large': { min: 1, max: 2 },
      gate: { min: 1, max: 2 },
      pond: { min: 1, max: 3 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [0, 17, 25],
      optionalEncounterTileIds: [7],
    },
  },
  {
    id: 'forest_town_route',
    label: 'Forest Town + Route',
    description: 'Town linked by forest corridors with encounter-heavy side spaces.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH,
      height: DEFAULT_MAP_HEIGHT + 4,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1,
      biomeVariety: 1.1,
      townCoherence: 0.9,
      encounterPacing: 1.3,
      landmarkVisibility: 0.8,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 1, max: 1 },
      'house-small': { min: 1, max: 4 },
      lab: { min: 0, max: 1 },
      'cave-entrance': { min: 0, max: 2 },
      gate: { min: 1, max: 2 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [17],
      optionalEncounterTileIds: [7, 28, 15],
    },
  },
  {
    id: 'mountain_pass_town_route',
    label: 'Mountain Pass Town + Route',
    description: 'Steeper overland route with lookout landmarks, caves, and tighter settlements.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 4,
      height: DEFAULT_MAP_HEIGHT + 6,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.25,
      biomeVariety: 0.95,
      townCoherence: 0.85,
      encounterPacing: 1.15,
      landmarkVisibility: 1.35,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 0, max: 1 },
      gym: { min: 0, max: 1 },
      'house-small': { min: 1, max: 3 },
      lab: { min: 0, max: 1 },
      'cave-entrance': { min: 1, max: 3 },
      gate: { min: 1, max: 3 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [17],
      optionalEncounterTileIds: [7, 15, 28],
    },
  },
  {
    id: 'riverlands_town_route',
    label: 'Riverlands Town + Route',
    description: 'Route runs through river flats with bridges, ponds, and broad encounter pockets.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 8,
      height: DEFAULT_MAP_HEIGHT + 2,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 0.95,
      biomeVariety: 1.25,
      townCoherence: 1,
      encounterPacing: 1.05,
      landmarkVisibility: 1.1,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 1, max: 1 },
      'house-small': { min: 2, max: 5 },
      'house-large': { min: 1, max: 2 },
      gate: { min: 1, max: 2 },
      pond: { min: 2, max: 4 },
      'fence-h': { min: 1, max: 4 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [0, 17, 25],
      optionalEncounterTileIds: [7, 28],
    },
  },
  {
    id: 'lakeside_hamlet_route',
    label: 'Lakeside Hamlet + Route',
    description: 'Compact settlement near open water with scenic loops and lighter structure density.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 2,
      height: DEFAULT_MAP_HEIGHT + 3,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.05,
      biomeVariety: 1.15,
      townCoherence: 1.1,
      encounterPacing: 0.9,
      landmarkVisibility: 1.2,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 0, max: 1 },
      'house-small': { min: 1, max: 3 },
      'house-large': { min: 1, max: 2 },
      gate: { min: 0, max: 1 },
      pond: { min: 2, max: 5 },
      'fence-v': { min: 1, max: 3 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [0, 17, 25],
      optionalEncounterTileIds: [7],
    },
  },
  {
    id: 'canyon_corridor_route',
    label: 'Canyon Corridor Route',
    description: 'Long corridor-style traversal with gates, sparse town hubs, and focused encounters.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 10,
      height: DEFAULT_MAP_HEIGHT - 1,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.35,
      biomeVariety: 0.85,
      townCoherence: 0.8,
      encounterPacing: 1.25,
      landmarkVisibility: 1.05,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 1, max: 1 },
      'house-small': { min: 1, max: 2 },
      gate: { min: 2, max: 4 },
      'cave-entrance': { min: 1, max: 2 },
      'fence-h': { min: 2, max: 5 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [17],
      optionalEncounterTileIds: [15, 28],
    },
  },
  {
    id: 'meadow_outskirts_route',
    label: 'Meadow Outskirts Route',
    description: 'Open outskirts with broad fields, village clusters, and gentle encounter pacing.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 6,
      height: DEFAULT_MAP_HEIGHT + 1,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 0.95,
      biomeVariety: 1.05,
      townCoherence: 1.25,
      encounterPacing: 0.85,
      landmarkVisibility: 1,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 1, max: 1 },
      gym: { min: 0, max: 1 },
      'house-small': { min: 3, max: 6 },
      'house-large': { min: 1, max: 3 },
      lab: { min: 0, max: 1 },
      pond: { min: 1, max: 2 },
      'fence-v': { min: 2, max: 5 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [0, 17],
      optionalEncounterTileIds: [7, 28],
    },
  },
  {
    id: 'deep_cave',
    label: 'Deep Cave',
    description: 'Dark underground cave with winding passages, rocks, rare encounters, and hidden items.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH,
      height: DEFAULT_MAP_HEIGHT + 4,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 0.8,
      biomeVariety: 0.7,
      townCoherence: 0.5,
      encounterPacing: 1.4,
      landmarkVisibility: 0.6,
    },
    buildingTargets: {},
    tileRoles: {
      baseTerrainTileId: 6,
      primaryPathTileId: 2,
      optionalWaterTileIds: [],
      optionalEncounterTileIds: [15, 28],
    },
  },
  {
    id: 'surfing_route',
    label: 'Surfing Route',
    description: 'Full water map for surfing with minimal land for entry/exit points.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 8,
      height: DEFAULT_MAP_HEIGHT,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.1,
      biomeVariety: 0.6,
      townCoherence: 0.3,
      encounterPacing: 1.2,
      landmarkVisibility: 0.7,
    },
    buildingTargets: {},
    tileRoles: {
      baseTerrainTileId: 25,
      primaryPathTileId: 25,
      optionalWaterTileIds: [0, 17],
      optionalEncounterTileIds: [25],
    },
  },
  {
    id: 'underwater_dive',
    label: 'Underwater Dive',
    description: 'Deep sea diving map with special items and rare water Pokemon.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 4,
      height: DEFAULT_MAP_HEIGHT + 2,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 0.9,
      biomeVariety: 0.5,
      townCoherence: 0.2,
      encounterPacing: 1.3,
      landmarkVisibility: 0.8,
    },
    buildingTargets: {},
    tileRoles: {
      baseTerrainTileId: 0,
      primaryPathTileId: 0,
      optionalWaterTileIds: [17, 25],
      optionalEncounterTileIds: [28],
    },
  },
  {
    id: 'volcano_crater',
    label: 'Volcano Crater',
    description: 'Volcanic terrain with lava flows, rocks, and fire encounters. Very dangerous.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH,
      height: DEFAULT_MAP_HEIGHT,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.2,
      biomeVariety: 0.6,
      townCoherence: 0.4,
      encounterPacing: 1.5,
      landmarkVisibility: 1.1,
    },
    buildingTargets: {
      'cave-entrance': { min: 1, max: 2 },
    },
    tileRoles: {
      baseTerrainTileId: 8,
      primaryPathTileId: 6,
      optionalWaterTileIds: [0],
      optionalEncounterTileIds: [7, 28],
    },
  },
  {
    id: 'seaside_boardwalk',
    label: 'Seaside Boardwalk',
    description: 'Coastal town with beach, water on one side, and a boardwalk feel.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 6,
      height: DEFAULT_MAP_HEIGHT,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1,
      biomeVariety: 1.2,
      townCoherence: 1.3,
      encounterPacing: 0.7,
      landmarkVisibility: 1.2,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 1, max: 1 },
      'house-small': { min: 2, max: 5 },
      'house-large': { min: 1, max: 3 },
      pond: { min: 1, max: 2 },
      gate: { min: 1, max: 2 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [0, 17, 25],
      optionalEncounterTileIds: [7],
    },
  },
  {
    id: 'dense_forest',
    label: 'Dense Forest',
    description: 'Heavy tree coverage with forest paths, hidden items, and lots of wild encounters.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 4,
      height: DEFAULT_MAP_HEIGHT + 6,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 0.7,
      biomeVariety: 0.9,
      townCoherence: 0.6,
      encounterPacing: 1.6,
      landmarkVisibility: 0.5,
    },
    buildingTargets: {
      'cave-entrance': { min: 0, max: 2 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [17],
      optionalEncounterTileIds: [7, 28],
    },
  },
  {
    id: 'gym_arena',
    label: 'Gym Arena',
    description: 'Indoor gym layout with battle zones, statues, and specific trainer placements. No random encounters.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH - 8,
      height: DEFAULT_MAP_HEIGHT - 6,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.3,
      biomeVariety: 0.3,
      townCoherence: 1.5,
      encounterPacing: 0,
      landmarkVisibility: 1.4,
    },
    buildingTargets: {
      gym: { min: 1, max: 1 },
    },
    tileRoles: {
      baseTerrainTileId: 2,
      primaryPathTileId: 2,
      optionalWaterTileIds: [],
      optionalEncounterTileIds: [],
    },
  },
  {
    id: 'battle_tower',
    label: 'Battle Tower',
    description: 'Multi-floor battle facility with statues, trainers, and no wild Pokemon.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH - 4,
      height: DEFAULT_MAP_HEIGHT - 4,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.2,
      biomeVariety: 0.2,
      townCoherence: 1.4,
      encounterPacing: 0,
      landmarkVisibility: 1.5,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      pokemart: { min: 0, max: 1 },
    },
    tileRoles: {
      baseTerrainTileId: 2,
      primaryPathTileId: 2,
      optionalWaterTileIds: [],
      optionalEncounterTileIds: [],
    },
  },
  {
    id: 'mountain_peak',
    label: 'Mountain Peak',
    description: 'High altitude with lots of rocks, cave entrances, thin paths, and rare encounters.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 2,
      height: DEFAULT_MAP_HEIGHT + 8,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.1,
      biomeVariety: 0.8,
      townCoherence: 0.5,
      encounterPacing: 1.2,
      landmarkVisibility: 1.6,
    },
    buildingTargets: {
      'cave-entrance': { min: 1, max: 3 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [17],
      optionalEncounterTileIds: [7, 28],
    },
  },
  {
    id: 'moon_colony',
    label: 'Moon Colony',
    description: 'Alien terrain with crater ground, weird encounters, and sci-fi items.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 6,
      height: DEFAULT_MAP_HEIGHT + 4,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 0.9,
      biomeVariety: 1.1,
      townCoherence: 0.7,
      encounterPacing: 1.1,
      landmarkVisibility: 1.3,
    },
    buildingTargets: {
      lab: { min: 1, max: 2 },
      'house-large': { min: 1, max: 3 },
    },
    tileRoles: {
      baseTerrainTileId: 6,
      primaryPathTileId: 2,
      optionalWaterTileIds: [],
      optionalEncounterTileIds: [28],
    },
  },
  {
    id: 'ship_deck',
    label: 'Ship Deck',
    description: 'Boat/ship environment with water surrounding, NPCs, items, and special trainers.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 2,
      height: DEFAULT_MAP_HEIGHT - 4,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 1.1,
      biomeVariety: 0.4,
      townCoherence: 1.2,
      encounterPacing: 0.6,
      landmarkVisibility: 1,
    },
    buildingTargets: {
      pokecenter: { min: 0, max: 1 },
      pokemart: { min: 0, max: 1 },
    },
    tileRoles: {
      baseTerrainTileId: 2,
      primaryPathTileId: 2,
      optionalWaterTileIds: [0, 17, 25],
      optionalEncounterTileIds: [],
    },
  },
  {
    id: 'safari_zone',
    label: 'Safari Zone',
    description: 'Wide open encounter-heavy area with tall grass, rare grass, and few structures.',
    recommendedDimensions: {
      width: DEFAULT_MAP_WIDTH + 12,
      height: DEFAULT_MAP_HEIGHT + 10,
    },
    passOrder: [...DEFAULT_GENERATION_PASSES],
    requiredHardConstraints: [...GENERATION_HARD_CONSTRAINTS],
    softGoalWeights: {
      routeReadability: 0.6,
      biomeVariety: 1.4,
      townCoherence: 0.4,
      encounterPacing: 1.8,
      landmarkVisibility: 0.9,
    },
    buildingTargets: {
      pokecenter: { min: 1, max: 1 },
      'house-small': { min: 0, max: 2 },
      pond: { min: 2, max: 5 },
    },
    tileRoles: {
      baseTerrainTileId: GRASS_TILE_ID,
      primaryPathTileId: 2,
      optionalWaterTileIds: [0, 17, 25],
      optionalEncounterTileIds: [7, 28],
    },
  },
]

export const RANDOM_MAP_ARCHETYPE_PRESETS_BY_ID: Record<ArchetypeId, RandomMapArchetype> =
  RANDOM_MAP_ARCHETYPE_PRESETS.reduce<Record<ArchetypeId, RandomMapArchetype>>((accumulator, archetype) => {
    accumulator[archetype.id] = archetype
    return accumulator
  }, {} as Record<ArchetypeId, RandomMapArchetype>)
